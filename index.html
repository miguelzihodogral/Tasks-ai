<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robô Chat de Tarefas</title>
    <!-- Carrega Tailwind CSS via CDN para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar para melhor visual */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4f46e5; /* indigo-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #1f2937; /* gray-800 */
        }
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'indigo-700': '#4338ca',
                        'gray-900': '#111827',
                        'gray-800': '#1f2937',
                        'gray-700': '#374151',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900">

    <div id="app" class="flex flex-col h-screen max-w-4xl mx-auto bg-gray-900 text-white shadow-2xl">

        <header class="p-4 bg-gray-800 border-b border-indigo-700 shadow-md flex items-center">
            <!-- Ícone Bot (SVG simples ou texto) -->
            <svg class="text-indigo-400 mr-3 w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.79 2-4 2s-4-.895-4-2 1.79-2 4-2 4 .895 4 2zM12 13V6"></path></svg>
            <h1 class="text-xl font-bold text-gray-100">Robô Chat de Tarefas</h1>
        </header>

        <!-- Área de Chat -->
        <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
            <!-- Mensagens serão inseridas aqui pelo JavaScript -->
        </main>

        <!-- Área de Input -->
        <footer class="p-4 bg-gray-800 border-t border-indigo-700">
            <!-- Pré-visualização de Arquivos Selecionados -->
            <div id="file-preview-container" class="flex gap-2 p-2 mb-2 bg-gray-700/50 rounded-lg overflow-x-auto hidden">
                <!-- Pré-visualizações de arquivo serão inseridas aqui -->
            </div>

            <form id="chat-form" class="flex space-x-2">
                <!-- Botões de Mídia -->
                <div class="flex space-x-1">
                    <label id="upload-label" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors duration-200 cursor-pointer text-indigo-400" title="Carregar Imagens (Max 10)">
                        <!-- Ícone Upload -->
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <input type="file" id="file-input" accept="image/*" multiple class="hidden" />
                    </label>
                    <label id="camera-label" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors duration-200 cursor-pointer text-indigo-400" title="Tirar Foto (Max 10)">
                        <!-- Ícone Camera -->
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.59 4h2.82c.456 0 .907.126 1.284.362l.812 1.218A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <input type="file" id="camera-input" accept="image/*" capture="environment" multiple class="hidden" />
                    </label>
                </div>

                <!-- Campo de Texto -->
                <input
                    type="text"
                    id="prompt-input"
                    placeholder="Digite sua pergunta ou instrução..."
                    class="flex-1 p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:border-indigo-500 text-white placeholder-gray-400"
                />

                <!-- Botão de Envio -->
                <button
                    type="submit"
                    id="send-button"
                    class="p-3 rounded-lg bg-gray-600 text-gray-400 cursor-not-allowed transition-all duration-300"
                    disabled
                >
                    <!-- Ícone Send -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </form>
            <p id="file-limit-message" class="text-yellow-400 text-xs mt-1 text-center hidden">
                Limite de 10 arquivos atingido para esta mensagem.
            </p>
        </footer>

    </div>

    <script>
        // === VARIÁVEIS GLOBAIS E CONFIGURAÇÕES ===
        const MAX_FILES = 10;
        const apiKey = "AIzaSyCE_c64RxdBan1OsRUA0jP57mXgJZb-UpM"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let selectedFiles = [];
        let processing = false;

        // Referências DOM
        const chatContainer = document.getElementById('chat-container');
        const fileInput = document.getElementById('file-input');
        const cameraInput = document.getElementById('camera-input');
        const promptInput = document.getElementById('prompt-input');
        const chatForm = document.getElementById('chat-form');
        const sendButton = document.getElementById('send-button');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const fileLimitMessage = document.getElementById('file-limit-message');
        const uploadLabel = document.getElementById('upload-label');
        const cameraLabel = document.getElementById('camera-label');

        // Estrutura de dados para o resultado da análise (do modelo React original)
        const responseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "fileName": { "type": "STRING", description: "Nome original do arquivo (e.g., Imagem 1)" },
                    "type": { "type": "STRING", enum: ["TAREFA", "PÁGINA INFORMATIVA", "NÃO RELEVANTE"], description: "TAREFA, PÁGINA INFORMATIVA ou NÃO RELEVANTE" },
                    "summary": { "type": "STRING", description: "Um breve resumo do conteúdo da imagem (e.g., Tarefa 11 ou Introdução ao Capítulo 3)" },
                    "items": {
                        "type": "ARRAY",
                        "description": "Array de pares pergunta/resposta, somente se type for TAREFA.",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "question": { "type": "STRING", description: "A pergunta extraída." },
                                "answer": { "type": "STRING", description: "A resposta direta e curta à pergunta." },
                                "justification": { "type": "STRING", description: "Justificativa breve da resposta. VAZIA se não solicitada pelo usuário." }
                            }
                        }
                    },
                    "generalResponse": { "type": "STRING", description: "Uma resposta em texto livre se a imagem for 'PÁGINA INFORMATIVA' ou 'NÃO RELEVANTE', ou se houver um erro na análise." }
                },
                required: ["fileName", "type", "summary", "generalResponse"]
            }
        };


        // === FUNÇÕES AUXILIARES ===

        /**
         * Converte um arquivo File em uma string Base64.
         */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = (error) => reject(error);
            });
        };

        /**
         * Função auxiliar para retry com backoff exponencial
         */
        const fetchWithRetry = async (url, options, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    // Espera antes de tentar novamente (1s, 2s, 4s)
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
            }
        };

        /**
         * Rola a área de chat para o fundo.
         */
        const scrollToBottom = () => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        /**
         * Atualiza o estado visual do botão de envio e inputs.
         */
        const updateSendButtonState = () => {
            const hasContent = promptInput.value.trim().length > 0 || selectedFiles.length > 0;
            const isDisabled = processing || !hasContent;

            sendButton.disabled = isDisabled;
            promptInput.disabled = processing;

            if (isDisabled) {
                sendButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'shadow-md', 'shadow-green-500/50');
                sendButton.classList.add('bg-gray-600', 'text-gray-400', 'cursor-not-allowed');
            } else {
                sendButton.classList.remove('bg-gray-600', 'text-gray-400', 'cursor-not-allowed');
                sendButton.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-md', 'shadow-green-500/50');
            }
            
            // Atualiza o estado dos botões de mídia
            const isLimitReached = selectedFiles.length >= MAX_FILES;
            const buttonClasses = isLimitReached ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-gray-700 hover:bg-gray-600 text-indigo-400 cursor-pointer';

            uploadLabel.className = uploadLabel.className.replace(/bg-.*?( |$)/g, '') + ' p-2 rounded-lg transition-colors duration-200 ' + buttonClasses;
            cameraLabel.className = cameraLabel.className.replace(/bg-.*?( |$)/g, '') + ' p-2 rounded-lg transition-colors duration-200 ' + buttonClasses;

            fileInput.disabled = isLimitReached || processing;
            cameraInput.disabled = isLimitReached || processing;

            if (isLimitReached) {
                fileLimitMessage.classList.remove('hidden');
            } else {
                fileLimitMessage.classList.add('hidden');
            }
        };
        
        // === RENDERIZAÇÃO DE ELEMENTOS ===

        /**
         * Cria e retorna o HTML para um resultado de análise estruturada.
         */
        const createStructuredResultElement = (result, index) => {
            const isTask = result.type === 'TAREFA';
            const IconSVG = isTask 
                ? '<svg class="text-green-400 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.253"></path></svg>'
                : '<svg class="text-gray-400 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';

            let contentHTML;

            if (isTask && result.items && result.items.length > 0) {
                const itemsHTML = result.items.map((item, qIndex) => {
                    const justification = item.justification && item.justification.trim() !== '' && item.justification.trim() !== '-'
                        ? `<p class="text-xs text-gray-400 italic mt-1 ml-5"><span class="font-semibold text-gray-300">Justificativa:</span> ${item.justification}</p>`
                        : '';

                    return `
                        <div class="pl-3 py-1 border-l-2 border-indigo-500">
                            <p class="font-medium text-gray-300 text-sm">
                                <span class="font-bold text-indigo-300">Q${qIndex + 1}:</span> ${item.question}
                            </p>
                            <div class="mt-1 ml-2">
                                <p class="text-green-400 font-bold text-sm flex items-center">
                                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Resposta:
                                </p>
                                <p class="text-white text-sm ml-5">${item.answer}</p>
                                ${justification}
                            </div>
                        </div>
                    `;
                }).join('');
                contentHTML = `<div class="space-y-4">${itemsHTML}</div>`;
            } else {
                contentHTML = `<p class="text-gray-400 text-sm italic">${result.generalResponse}</p>`;
            }

            const element = document.createElement('div');
            element.className = "bg-gray-700/50 p-4 rounded-lg shadow-inner";
            element.innerHTML = `
                <div class="flex items-center space-x-2 mb-3 border-b border-gray-600 pb-2">
                    ${IconSVG}
                    <h4 class="text-base font-semibold ${isTask ? 'text-green-400' : 'text-gray-400'}">
                        ${result.type} ${result.summary ? `(${result.summary})` : ''}
                    </h4>
                    <span class="text-xs text-gray-400 ml-auto">(${result.fileName})</span>
                </div>
                ${contentHTML}
            `;
            return element;
        };
        
        /**
         * Adiciona uma mensagem ao chat.
         */
        const renderChatMessage = (message) => {
            const isUser = message.role === 'user';
            const align = isUser ? 'justify-end' : 'justify-start';
            const bgColor = isUser ? 'bg-indigo-700' : 'bg-gray-800';
            
            const IconSVG = isUser
                ? '<svg class="text-white w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>'
                : '<svg class="text-white w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.79 2-4 2s-4-.895-4-2 1.79-2 4-2 4 .895 4 2zM12 13V6"></path></svg>';
                
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex w-full ${align} mb-4`;
            
            const innerContent = document.createElement('div');
            innerContent.className = `flex items-start max-w-[90%] sm:max-w-[75%] md:max-w-[60%] lg:max-w-[50%]`;
            
            const iconWrapper = document.createElement('div');
            iconWrapper.className = "p-2 bg-indigo-500 rounded-full flex-shrink-0 " + (isUser ? 'ml-3' : 'mr-3');
            iconWrapper.innerHTML = IconSVG;

            const contentBox = document.createElement('div');
            contentBox.className = `p-4 rounded-xl ${bgColor} shadow-lg space-y-3`;
            
            // 1. Conteúdo de Texto
            if (message.content && typeof message.content === 'string') {
                const textP = document.createElement('p');
                textP.className = "whitespace-pre-wrap text-gray-100";
                textP.textContent = message.content;
                contentBox.appendChild(textP);
            }

            // 2. Imagens Enviadas (Apenas User)
            if (isUser && message.files && message.files.length > 0) {
                const fileContainer = document.createElement('div');
                fileContainer.className = "pt-2 border-t border-indigo-600/50";
                
                const filesP = document.createElement('p');
                filesP.className = "text-xs font-semibold text-gray-300 mb-2";
                filesP.textContent = `Imagens anexadas (${message.files.length}):`;
                fileContainer.appendChild(filesP);

                const imgFlex = document.createElement('div');
                imgFlex.className = "flex flex-wrap gap-2";

                message.files.forEach((file, index) => {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.alt = `Anexo ${index + 1}`;
                    img.className = "w-16 h-16 object-cover rounded-md border border-indigo-500/50";
                    imgFlex.appendChild(img);
                });
                
                fileContainer.appendChild(imgFlex);
                contentBox.appendChild(fileContainer);
            }

            // 3. Resposta Estruturada (Apenas AI)
            if (message.isStructured && Array.isArray(message.content)) {
                const structuredContainer = document.createElement('div');
                structuredContainer.className = "pt-3 border-t border-gray-700/50 space-y-6";
                
                const titleP = document.createElement('p');
                titleP.className = "text-sm font-semibold text-indigo-400";
                titleP.textContent = 'Análise Organizada:';
                structuredContainer.appendChild(titleP);

                message.content.forEach((result, index) => {
                    const resultElement = createStructuredResultElement(result, index);
                    structuredContainer.appendChild(resultElement);
                });

                contentBox.appendChild(structuredContainer);
            }

            // Montagem final
            if (!isUser) {
                innerContent.appendChild(iconWrapper);
            }
            innerContent.appendChild(contentBox);
            if (isUser) {
                innerContent.appendChild(iconWrapper);
            }
            
            messageWrapper.appendChild(innerContent);
            chatContainer.appendChild(messageWrapper);
            scrollToBottom();
        };

        /**
         * Adiciona um indicador de processamento/loading.
         */
        const renderLoadingIndicator = (fileCount) => {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start mb-4';
            loadingDiv.innerHTML = `
                <div class="p-2 bg-indigo-500 rounded-full flex-shrink-0 mr-3">
                    <svg class="text-white w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.79 2-4 2s-4-.895-4-2 1.79-2 4-2 4 .895 4 2zM12 13V6"></path></svg>
                </div>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg flex items-center text-gray-300 italic">
                    <svg class="w-4 h-4 animate-spin mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.34 3.732m.256 12.385l-1.353 1.353C1.65 18.59 2.45 20.35 4.3 20.7a9 9 0 0015.65-4.437"></path></svg>
                    O Robô está organizando e resolvendo... (Processando ${fileCount} imagens)
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();
        };

        /**
         * Remove o indicador de processamento/loading.
         */
        const removeLoadingIndicator = () => {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        };

        /**
         * Atualiza a área de pré-visualização de arquivos.
         */
        const updateFilePreview = () => {
            filePreviewContainer.innerHTML = '';
            
            if (selectedFiles.length === 0) {
                filePreviewContainer.classList.add('hidden');
                return;
            }

            filePreviewContainer.classList.remove('hidden');

            selectedFiles.forEach((file, index) => {
                const objectUrl = URL.createObjectURL(file);
                
                const previewDiv = document.createElement('div');
                previewDiv.className = "relative w-16 h-16 rounded-lg overflow-hidden flex-shrink-0 shadow-md";
                previewDiv.innerHTML = `
                    <img src="${objectUrl}" alt="Pré-visualização ${index + 1}" class="w-full h-full object-cover" />
                    <button data-index="${index}" class="remove-file-btn absolute top-0 right-0 p-0.5 bg-red-600 rounded-bl-lg text-white hover:bg-red-700 transition-colors" aria-label="Remover arquivo ${index + 1}">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                filePreviewContainer.appendChild(previewDiv);
            });
            updateSendButtonState();
        };
        
        // === HANDLERS DE EVENTOS ===
        
        /**
         * Remove um arquivo selecionado.
         */
        const handleRemoveFile = (indexToRemove) => {
            selectedFiles = selectedFiles.filter((_, index) => index !== indexToRemove);
            updateFilePreview();
        };

        /**
         * Lida com a seleção de arquivos (input e camera).
         */
        const handleFileChange = (event) => {
            const files = Array.from(event.target.files).filter(file => file.type.startsWith('image/'));
            selectedFiles = [...selectedFiles, ...files].slice(0, MAX_FILES);
            event.target.value = null; // Limpa o input para permitir o upload do mesmo arquivo
            updateFilePreview();
        };

        /**
         * Lida com o envio da mensagem.
         */
        const handleSend = async (e) => {
            e.preventDefault();

            const textPrompt = promptInput.value.trim();
            const filesToSend = [...selectedFiles];
            const fileCount = filesToSend.length;

            // Verifica se há conteúdo ou se já está processando
            if ((!textPrompt && fileCount === 0) || processing) return;

            // 1. Atualiza estados e UI
            processing = true;
            updateSendButtonState();
            
            // Renderiza mensagem do usuário
            renderChatMessage({ role: 'user', content: textPrompt, files: filesToSend });
            renderLoadingIndicator(fileCount);

            // Limpa inputs
            promptInput.value = '';
            selectedFiles = [];
            updateFilePreview();
            
            try {
                // 2. Converte arquivos para Base64 (assíncrono e paralelo)
                const base64Parts = await Promise.all(
                    filesToSend.map(file => fileToBase64(file).then(base64 => ({
                        inlineData: {
                            mimeType: file.type || 'image/jpeg',
                            data: base64
                        }
                    })))
                );

                // 3. Define prompt e payload
                const requiresJustification = /justifique|justifica|por\s+quê|motivo|explica/i.test(textPrompt);

                const justificationInstruction = requiresJustification
                    ? "Obrigatório: Inclua uma 'justification' concisa para cada 'answer'."
                    : "IMPORTANTE: O campo 'justification' DEVE SER UMA STRING VAZIA ('') para todas as questões. Isso é CRÍTICO para a velocidade de resposta.";

                const systemPrompt = `Você é um robô de resolução de tarefas altamente organizado e um assistente de chat. Sua FUNÇÃO PRIMÁRIA é entregar a resposta EM NO MÁXIMO 20 SEGUNDOS. PRIORIZE A VELOCIDADE acima de qualquer detalhe.
                
                Regras de Resposta para garantir o português correto e natural:
                - As respostas (tanto nas 'answer's quanto na 'generalResponse') devem ser completas, gramaticalmente corretas e usar linguagem natural em português (Ex: 'A raça desse cachorro é Pinscher.').
                - Garanta a concordância pronominal e mantenha o contexto da pergunta do usuário (Ex: use 'esse cachorro' se o usuário usou 'esse cachorro').
                - As 'answer's devem ser concisas, mas sem limite estrito de palavras.
                - ${justificationInstruction}
                
                1. Se houver imagens: Siga estritamente o formato JSON para analisar cada imagem (max ${MAX_FILES} imagens) na ordem. Identifique se é 'TAREFA' (resolva a questão) ou 'PÁGINA INFORMATIVA'/'NÃO RELEVANTE'.
                2. Se não houver imagens: Responda à consulta de texto do usuário como um assistente de IA normal.
                3. Resposta em texto livre (generalResponse) deve ser curta, mas completa.`; // Mudei aqui

                let finalUserQuery;
                let contents;
                let useStructuredResponse = fileCount > 0;

                if (useStructuredResponse) {
                    finalUserQuery = `Instrução do usuário: "${textPrompt}". Analise as ${fileCount} imagens anexadas na ordem em que foram fornecidas, aplicando a instrução.`;
                    contents = [
                        { role: "user", parts: [{ text: finalUserQuery }, ...base64Parts] }
                    ];
                } else {
                    finalUserQuery = textPrompt;
                    contents = [
                        { role: "user", parts: [{ text: finalUserQuery }] }
                    ];
                }

                const payload = {
                    contents: contents,
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: useStructuredResponse ? {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema,
                    } : {},
                };

                // 4. Chamada à API
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                let aiResponse;
                if (result.candidates && result.candidates.length > 0) {
                    const textPart = result.candidates[0].content.parts.find(p => p.text);
                    const jsonText = textPart?.text;

                    if (useStructuredResponse && jsonText) {
                        try {
                            const parsedJson = JSON.parse(jsonText);
                            aiResponse = { role: 'ai', content: parsedJson, isStructured: true };
                        } catch (jsonError) {
                            aiResponse = { role: 'ai', content: `O robô teve dificuldades em estruturar a resposta para suas ${fileCount} imagens, mas aqui está a análise: \n\n ${jsonText}`, isStructured: false };
                            console.error("JSON Parsing Error:", jsonError, "Raw Text:", jsonText);
                        }
                    } else if (textPart?.text) {
                        aiResponse = { role: 'ai', content: textPart.text, isStructured: false };
                    } else {
                        aiResponse = { role: 'ai', content: 'Desculpe, não consegui processar a sua solicitação. Tente novamente.', isStructured: false };
                    }
                } else {
                    aiResponse = { role: 'ai', content: 'Ocorreu um erro ao conectar com o serviço de IA. Por favor, verifique sua conexão e tente novamente.', isStructured: false };
                }

                // 5. Renderiza a resposta da AI
                renderChatMessage(aiResponse);

            } catch (error) {
                console.error("Erro no processamento:", error);
                renderChatMessage({ role: 'ai', content: 'Ocorreu uma falha grave na comunicação. Por favor, tente novamente.', isStructured: false });
            } finally {
                processing = false;
                removeLoadingIndicator();
                updateSendButtonState();
            }
        };
        
        // === INICIALIZAÇÃO ===
        window.onload = () => {
            // Adiciona a mensagem de boas-vindas inicial
            renderChatMessage({ 
                role: 'ai', 
                content: 'Olá! Eu sou o Robô Organizador de Tarefas. Você pode me enviar até 10 imagens de uma vez e um texto guia. Minhas respostas são diretas e organizadas por documento. Qual é a sua primeira tarefa?',
                isStructured: false
            });
            
            // Adiciona listeners
            fileInput.addEventListener('change', handleFileChange);
            cameraInput.addEventListener('change', handleFileChange);
            chatForm.addEventListener('submit', handleSend);
            
            // Listener para o input de texto, para habilitar/desabilitar o botão de envio
            promptInput.addEventListener('input', updateSendButtonState);
            
            // Listener para os botões de remover arquivo na pré-visualização
            filePreviewContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-file-btn')) {
                    const button = e.target.closest('.remove-file-btn');
                    const index = parseInt(button.getAttribute('data-index'));
                    handleRemoveFile(index);
                }
            });
            
            // Atualiza o estado inicial do botão
            updateSendButtonState();
        };

    </script>
</body>
</html>
