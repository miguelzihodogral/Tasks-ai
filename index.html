<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskSolver AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados e para o Dark Mode do Tailwind */
        :root {
            color-scheme: light;
        }
        .dark {
            color-scheme: dark;
        }
        /* Ajuste do scrollbar para melhor visualiza√ß√£o */
        #chat-window {
            height: calc(100vh - 12rem); /* Altura da tela menos o cabe√ßalho e a √°rea de input */
            overflow-y: auto;
        }
        /* Estilos para miniaturas de imagens */
        .image-preview {
            max-height: 100px;
            width: auto;
            border-radius: 8px;
            object-fit: cover;
            margin: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .image-preview:hover {
            transform: scale(1.05);
        }
        /* Estilo para anima√ß√£o de carregamento */
        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60%, 100% { content: ' ...'; }
        }
    </style>
    <script>
        // Configura√ß√£o do Tailwind para altern√¢ncia de tema
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'task-primary': 'var(--task-primary-color)',
                        'task-secondary': 'var(--task-secondary-color)',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">

    <div id="app" class="max-w-4xl mx-auto p-4 flex flex-col h-screen">

        <header class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 mb-4 sticky top-0 bg-white dark:bg-gray-900 z-10 rounded-xl shadow-lg dark:shadow-xl">
            <h1 class="text-3xl font-extrabold text-blue-600 dark:text-blue-400">TaskSolver AI ü§ñ</h1>
            <button id="theme-toggle" class="p-2 rounded-full text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-300">
                <span id="theme-icon" class="text-xl">‚òÄÔ∏è</span>
            </button>
        </header>

        <div id="chat-window" class="flex-grow p-2 space-y-4 mb-4 bg-white dark:bg-gray-800 rounded-xl shadow-inner border border-gray-100 dark:border-gray-700">
            <div class="flex justify-center items-center h-full initial-message">
                <p class="text-gray-500 dark:text-gray-400 text-lg">Envie uma tarefa e imagens para come√ßar!</p>
            </div>
        </div>

        <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-100 dark:border-gray-700">

            <div id="image-preview-container" class="flex flex-wrap gap-2 mb-2">
                </div>

            <div class="flex items-center space-x-3">
                
                <label for="image-upload" class="p-3 bg-blue-500 text-white rounded-full cursor-pointer hover:bg-blue-600 transition duration-300 flex items-center justify-center" title="Upload de M√∫ltiplas Imagens">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18.75 3.375h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12.75a1.5 1.5 0 0 0 1.5 1.5Z" />
                    </svg>
                </label>
                <input type="file" id="image-upload" accept="image/*" multiple class="hidden">

                <input type="text" id="prompt-input" placeholder="Digite sua tarefa aqui (e adicione imagens)..."
                       class="flex-grow p-3 border border-gray-300 dark:border-gray-700 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white transition duration-300"
                       onkeydown="if(event.key === 'Enter') document.getElementById('send-button').click()">

                <button id="send-button"
                        class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center w-12 h-12">
                    <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A5.996 5.996 0 0118.73 3.126L21.461 12 18.73 20.874A5.996 5.996 0 013.269 20.874L6 12z" />
                    </svg>
                    <svg id="stop-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.25 15.75H13.75V8.25H10.25V15.75Z" />
                        <circle cx="12" cy="12" r="9" />
                    </svg>
                </button>

            </div>
        </div>

    </div>

    <script>
        // CRUCIAL: Vari√°veis da API
        const apiKey = "AIzaSyDZr_Omq4MIo51YJKdShyoz7visDj37sDE";
        const geminiModel = "gemini-2.5-flash"; // Modelo para chat/multimodal
        const ttsModel = "gemini-2.5-flash-preview-tts"; // Modelo para s√≠ntese de voz
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');

        let abortController = null;
        let selectedFiles = [];

        // --- 1. L√ìGICA DE TEMA (Modo Claro/Escuro Persistente) ---
        
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        
        // Fun√ß√£o para aplicar o tema
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIcon.textContent = 'üåô';
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.textContent = '‚òÄÔ∏è';
            }
            localStorage.setItem('theme', theme);
        }

        // Inicializa o tema ao carregar
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark'); // Usa prefer√™ncia do sistema se n√£o houver tema salvo
        } else {
            applyTheme('light');
        }

        // Listener para o bot√£o de altern√¢ncia
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });

        // --- 2. MANIPULA√á√ÉO DE IMAGENS ---

        // Exibe a pr√©-visualiza√ß√£o das imagens selecionadas
        imageUpload.addEventListener('change', (event) => {
            selectedFiles = Array.from(event.target.files);
            imagePreviewContainer.innerHTML = ''; // Limpa as pr√©-visualiza√ß√µes anteriores

            selectedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;
                    img.className = 'image-preview border border-gray-300 dark:border-gray-600 p-1 bg-white dark:bg-gray-700';
                    imagePreviewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        // Converte o arquivo de imagem para o formato Base64 esperado pela API
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- 3. L√ìGICA DO CHAT/API GEMINI (Multimodal, Interrup√ß√£o, TTS) ---

        // Remove a mensagem inicial de "start"
        function removeInitialMessage() {
            const initialMsg = document.querySelector('.initial-message');
            if (initialMsg) {
                initialMsg.remove();
            }
        }

        // Fun√ß√£o para criar um bal√£o de mensagem no chat
        function createMessageElement(text, sender, imageUrls = []) {
            removeInitialMessage(); // Garante que a mensagem inicial seja removida
            
            const isUser = sender === 'user';
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
            
            let htmlContent = `
                <div class="max-w-3/4 p-4 rounded-xl ${isUser ? 'bg-blue-100 dark:bg-blue-900 text-gray-900 dark:text-gray-100' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100'} shadow-md">
                    ${isUser && imageUrls.length > 0 ? 
                        `<div class="flex flex-wrap gap-2 mb-2 p-1 border-b border-gray-300 dark:border-gray-600">
                            ${imageUrls.map(url => `<img src="${url}" class="image-preview w-20 h-20" alt="Imagem enviada">`).join('')}
                        </div>` 
                        : ''}
                    <p class="whitespace-pre-wrap">${text}</p>
                    ${!isUser ? `<button class="tts-button mt-2 p-2 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition duration-300" data-text="${text.replace(/"/g, '&quot;')}">Ouvir Solu√ß√£o ‚ú®</button>` : ''}
                </div>
            `;
            messageDiv.innerHTML = htmlContent;
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll para o final
            return messageDiv; // Retorna o elemento para manipula√ß√£o futura (ex: loading)
        }
        
        // Fun√ß√£o para adicionar um bal√£o de erro
        function displayError(message) {
            removeInitialMessage();
            const errorDiv = document.createElement('div');
            errorDiv.className = `flex justify-center mb-4`;
            errorDiv.innerHTML = `
                <div class="max-w-full p-4 rounded-xl bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 shadow-md border border-red-400">
                    <strong>üö´ Erro:</strong> ${message}
                </div>
            `;
            chatWindow.appendChild(errorDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Fun√ß√£o principal de envio
        async function sendMessage() {
            if (abortController) {
                // Interrup√ß√£o de Gera√ß√£o
                abortController.abort();
                abortController = null;
                updateSendButton('send');
                displayError("Gera√ß√£o da resposta cancelada pelo usu√°rio.");
                return;
            }

            const prompt = promptInput.value.trim();
            if (!prompt && selectedFiles.length === 0) {
                displayError("Por favor, digite uma tarefa ou adicione imagens.");
                return;
            }

            // 1. Prepara dados e interface
            updateSendButton('stop');
            promptInput.disabled = true;

            const userImageUrls = selectedFiles.map(file => URL.createObjectURL(file));
            createMessageElement(prompt || "Tarefa com Imagens", 'user', userImageUrls);
            
            const aiMessageElement = createMessageElement('<span class="loading-dots">Aguardando resposta da AI</span>', 'ai');
            const aiTextElement = aiMessageElement.querySelector('p');
            const aiButtonElement = aiMessageElement.querySelector('.tts-button');
            aiButtonElement.style.display = 'none'; // Esconde o bot√£o TTS inicialmente
            
            try {
                // 2. Monta o corpo da requisi√ß√£o (Multimodal)
                const parts = [];
                for (const file of selectedFiles) {
                    const base64Data = await fileToBase64(file);
                    parts.push({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type
                        }
                    });
                }
                if (prompt) {
                    parts.push({ text: prompt });
                }

                // Instru√ß√£o de Sistema
                const systemInstruction = "Voc√™ √© um Assistente de Resolu√ß√£o de Tarefas ultra-r√°pido. Analise as quest√µes e SEMPRE responda de forma extremamente curta, direta e concisa, separando as solu√ß√µes por quest√£o (se houver v√°rias).";

                const requestBody = {
                    contents: [{ role: "user", parts: parts }],
                    config: {
                        systemInstruction: systemInstruction,
                        temperature: 0.1, // Recomendado para tarefas de resolu√ß√£o
                    }
                };

                // 3. Chamada √† API
                abortController = new AbortController();
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`Erro na API: ${errorJson.error.message || response.statusText}`);
                }

                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Desculpe, n√£o consegui gerar uma resposta concisa.";

                // 4. Atualiza a interface
                aiTextElement.textContent = aiResponseText;
                aiButtonElement.dataset.text = aiResponseText;
                aiButtonElement.style.display = 'inline-block';
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    // Trata falhas de API e rede
                    aiTextElement.innerHTML = `<strong>Falha na Tarefa:</strong> ${error.message}.`;
                    displayError(`Houve um erro na requisi√ß√£o √† AI. Detalhe: ${error.message}`);
                }
            } finally {
                // 5. Limpeza
                // Revoga URLs de objetos criados para as pr√©-visualiza√ß√µes
                userImageUrls.forEach(url => URL.revokeObjectURL(url));
                
                abortController = null;
                updateSendButton('send');
                promptInput.disabled = false;
                promptInput.value = '';
                imageUpload.value = ''; // Limpa o input de arquivo
                imagePreviewContainer.innerHTML = '';
                selectedFiles = [];
            }
        }
        
        // Fun√ß√£o para alternar o √≠cone e o estado do bot√£o
        function updateSendButton(state) {
            const sendIcon = document.getElementById('send-icon');
            const stopIcon = document.getElementById('stop-icon');
            
            if (state === 'stop') {
                sendButton.classList.add('bg-red-500', 'hover:bg-red-600');
                sendButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                sendIcon.classList.add('hidden');
                stopIcon.classList.remove('hidden');
                sendButton.title = 'Parar Gera√ß√£o';
            } else {
                sendButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                sendButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                sendIcon.classList.remove('hidden');
                stopIcon.classList.add('hidden');
                sendButton.title = 'Enviar Tarefa';
            }
        }

        // --- 4. S√çNTESE DE VOZ (TTS) ---
        
        // Fun√ß√£o para chamar o TTS e reproduzir o √°udio
        async function playTTS(text, button) {
            button.disabled = true;
            button.textContent = 'Gerando √Åudio... üéß';

            try {
                const requestBody = {
                    text: text,
                    // O modelo √© 'gemini-2.5-flash-preview-tts', especificado na URL da requisi√ß√£o
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${ttsModel}:synthesize?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`Erro TTS: ${errorJson.error.message || response.statusText}`);
                }

                // A resposta √© um blob contendo o arquivo de √°udio
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                const audio = new Audio(audioUrl);
                audio.play();

                // Adiciona um listener para reativar o bot√£o ap√≥s o √°udio terminar
                audio.onended = () => {
                    button.disabled = false;
                    button.textContent = 'Ouvir Solu√ß√£o ‚ú®';
                    URL.revokeObjectURL(audioUrl); // Libera o recurso
                };
                
            } catch (error) {
                console.error("Erro no TTS:", error);
                button.textContent = '‚ùå Erro no √Åudio';
                button.disabled = false;
                setTimeout(() => {
                    button.textContent = 'Ouvir Solu√ß√£o ‚ú®';
                }, 3000);
            }
        }

        // Listener global para o bot√£o TTS
        chatWindow.addEventListener('click', (event) => {
            if (event.target.classList.contains('tts-button')) {
                const text = event.target.dataset.text;
                // Preven√ß√£o extra: garante que o texto n√£o esteja vazio antes de tentar o TTS
                if (text && text.trim() !== '') {
                    playTTS(text, event.target);
                } else {
                    event.target.textContent = 'Sem texto para √°udio';
                }
            }
        });

        // Event listener para o bot√£o de envio
        sendButton.addEventListener('click', sendMessage);

    </script>
</body>
</html>
