<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskSolver AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos e l√≥gica de Tema mantidos */
        :root {
            color-scheme: light;
        }
        .dark {
            color-scheme: dark;
        }
        #chat-window {
            height: calc(100vh - 12rem);
            overflow-y: auto;
        }
        .image-preview {
            max-height: 100px;
            width: auto;
            border-radius: 8px;
            object-fit: cover;
            margin: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .image-preview:hover {
            transform: scale(1.05);
        }
        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60%, 100% { content: ' ...'; }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'task-primary': 'var(--task-primary-color)',
                        'task-secondary': 'var(--task-secondary-color)',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">

    <div id="app" class="max-w-4xl mx-auto p-4 flex flex-col h-screen">

        <header class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 mb-4 sticky top-0 bg-white dark:bg-gray-900 z-10 rounded-xl shadow-lg dark:shadow-xl">
            <h1 class="text-3xl font-extrabold text-blue-600 dark:text-blue-400">TaskSolver AI ü§ñ</h1>
            <button id="theme-toggle" class="p-2 rounded-full text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-300">
                <span id="theme-icon" class="text-xl">‚òÄÔ∏è</span>
            </button>
        </header>

        <div id="chat-window" class="flex-grow p-2 space-y-4 mb-4 bg-white dark:bg-gray-800 rounded-xl shadow-inner border border-gray-100 dark:border-gray-700">
            <div class="flex justify-center items-center h-full initial-message">
                <p class="text-gray-500 dark:text-gray-400 text-lg">Envie sua tarefa e **at√© 10 imagens** para come√ßar!</p>
            </div>
        </div>

        <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-100 dark:border-gray-700">

            <div id="image-preview-container" class="flex flex-wrap gap-2 mb-2">
                </div>
            <p id="image-count" class="text-sm text-gray-500 dark:text-gray-400 mb-2">0/10 imagens selecionadas.</p>

            <div class="flex items-center space-x-3">
                
                <label for="image-upload" class="p-3 bg-blue-500 text-white rounded-full cursor-pointer hover:bg-blue-600 transition duration-300 flex items-center justify-center" title="Upload de M√∫ltiplas Imagens">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18.75 3.375h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12.75a1.5 1.5 0 0 0 1.5 1.5Z" />
                    </svg>
                </label>
                <input type="file" id="image-upload" accept="image/*" multiple class="hidden">

                <input type="text" id="prompt-input" placeholder="Descreva sua tarefa e o que preciso fazer com as imagens..."
                       class="flex-grow p-3 border border-gray-300 dark:border-gray-700 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white transition duration-300"
                       onkeydown="if(event.key === 'Enter') document.getElementById('send-button').click()">

                <button id="send-button"
                        class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center w-12 h-12">
                    <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A5.996 5.996 0 0118.73 3.126L21.461 12 18.73 20.874A5.996 5.996 0 013.269 20.874L6 12z" />
                    </svg>
                    <svg id="stop-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.25 15.75H13.75V8.25H10.25V15.75Z" />
                        <circle cx="12" cy="12" r="9" />
                    </svg>
                </button>

            </div>
        </div>

    </div>

    <script>
        // CRUCIAL: Sua Chave de API
        const apiKey = "AIzaSyCE_c64RxdBan1OsRUA0jP57mXgJZb-UpM";
        const geminiModel = "gemini-2.5-flash"; 
        const MAX_IMAGES = 10; // Definindo o limite m√°ximo de imagens
        
        // Elementos DOM
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imageCountDisplay = document.getElementById('image-count'); // Novo elemento para exibir a contagem

        let abortController = null;
        let selectedFiles = [];

        // --- L√ìGICA DE TEMA ---
        
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIcon.textContent = 'üåô';
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.textContent = '‚òÄÔ∏è';
            }
            localStorage.setItem('theme', theme);
        }

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });

        // --- MANIPULA√á√ÉO DE IMAGENS ---

        imageUpload.addEventListener('change', (event) => {
            // Filtra para garantir que n√£o exceda o limite de MAX_IMAGES
            // CRUCIAL: Se o usu√°rio tentar selecionar 10 de uma vez, newFiles ter√° 10 itens.
            const newFiles = Array.from(event.target.files).slice(0, MAX_IMAGES);
            selectedFiles = newFiles; 

            imagePreviewContainer.innerHTML = ''; // Limpa as pr√©-visualiza√ß√µes anteriores

            selectedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;
                    img.className = 'image-preview border border-gray-300 dark:border-gray-600 p-1 bg-white dark:bg-gray-700';
                    imagePreviewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
            updateImageCountDisplay(); // Atualiza a contagem exibida
        });

        function updateImageCountDisplay() {
            imageCountDisplay.textContent = `${selectedFiles.length}/${MAX_IMAGES} imagens selecionadas.`;
            if (selectedFiles.length === MAX_IMAGES) {
                imageCountDisplay.classList.remove('text-gray-500');
                imageCountDisplay.classList.add('text-orange-500', 'font-semibold');
            } else {
                imageCountDisplay.classList.remove('text-orange-500', 'font-semibold');
                imageCountDisplay.classList.add('text-gray-500');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- L√ìGICA DO CHAT/API GEMINI ---

        function removeInitialMessage() {
            const initialMsg = document.querySelector('.initial-message');
            if (initialMsg) {
                initialMsg.remove();
            }
        }

        function createMessageElement(text, sender, imageUrls = []) {
            removeInitialMessage();
            
            const isUser = sender === 'user';
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
            
            let htmlContent = `
                <div class="max-w-3/4 p-4 rounded-xl ${isUser ? 'bg-blue-100 dark:bg-blue-900 text-gray-900 dark:text-gray-100' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100'} shadow-md">
                    ${isUser && imageUrls.length > 0 ? 
                        `<div class="flex flex-wrap gap-2 mb-2 p-1 border-b border-gray-300 dark:border-gray-600">
                            ${imageUrls.map(url => `<img src="${url}" class="image-preview w-20 h-20" alt="Imagem enviada">`).join('')}
                        </div>` 
                        : ''}
                    <p class="whitespace-pre-wrap">${text}</p>
                </div>
            `;
            messageDiv.innerHTML = htmlContent;
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv;
        }
        
        function displayError(message) {
            removeInitialMessage();
            const errorDiv = document.createElement('div');
            errorDiv.className = `flex justify-center mb-4`;
            errorDiv.innerHTML = `
                <div class="max-w-full p-4 rounded-xl bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 shadow-md border border-red-400">
                    <strong>üö´ Erro:</strong> ${message}
                </div>
            `;
            chatWindow.appendChild(errorDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function sendMessage() {
            if (abortController) {
                abortController.abort();
                abortController = null;
                updateSendButton('send');
                displayError("Gera√ß√£o da resposta cancelada pelo usu√°rio.");
                return;
            }

            const prompt = promptInput.value.trim();
            if (!prompt && selectedFiles.length === 0) {
                displayError("Por favor, digite uma tarefa ou adicione imagens.");
                return;
            }

            updateSendButton('stop');
            promptInput.disabled = true;

            const userImageUrls = selectedFiles.map(file => URL.createObjectURL(file));
            createMessageElement(prompt || "Tarefa com Imagens", 'user', userImageUrls);
            
            const aiMessageElement = createMessageElement('<span class="loading-dots">Aguardando resposta da AI</span>', 'ai');
            const aiTextElement = aiMessageElement.querySelector('p');
            
            try {
                // INSTRU√á√ÉO DE SISTEMA APRIMORADA PARA ORGANIZA√á√ÉO DA RESPOSTA
                const systemInstruction = `
                    Voc√™ √© um Assistente de Resolu√ß√£o de Tarefas ultra-r√°pido e organizado.
                    Analise as imagens e o prompt do usu√°rio.
                    Sua tarefa √© identificar quest√µes ou problemas nas imagens e fornecer solu√ß√µes concisas.
                    Se houver v√°rias imagens que pare√ßam ser de tarefas ou quest√µes diferentes, organize sua resposta da seguinte forma:
                    1.  Identifique a "Tarefa" e seu n√∫mero se houver (ex: "Tarefa 11", "Quest√£o 3").
                    2.  Se uma imagem n√£o tiver uma identifica√ß√£o clara de tarefa, atribua a ela um n√∫mero sequencial (ex: "Tarefa 1", "Tarefa 2" etc. ou continue de um n√∫mero identificado).
                    3.  Forne√ßa a solu√ß√£o para CADA TAREFA de forma separada, clara e concisa.
                    4.  Use cabe√ßalhos simples como "### Tarefa X" ou "### Quest√£o Y" para cada solu√ß√£o.
                    5.  Sempre priorize a resolu√ß√£o direta do problema.
                    
                    Exemplo de formato esperado para a resposta:
                    ### Tarefa 11
                    [Solu√ß√£o concisa para a Tarefa 11]

                    ### Tarefa 12
                    [Solu√ß√£o concisa para a Tarefa 12]

                    ### Tarefa 1 (Imagem sem identifica√ß√£o clara)
                    [Solu√ß√£o concisa para a primeira imagem sem identifica√ß√£o]
                    
                    Agora, analise as imagens e o prompt:
                `;
                
                const parts = [];

                // Adiciona a instru√ß√£o e o prompt de texto como a primeira parte
                parts.push({ text: systemInstruction + prompt });

                // Adiciona as imagens
                for (const file of selectedFiles) {
                    const base64Data = await fileToBase64(file);
                    parts.push({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type
                        }
                    });
                }
                
                const requestBody = {
                    contents: [{ role: "user", parts: parts }],
                };

                abortController = new AbortController();
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`Erro na API: ${errorJson.error.message || response.statusText}`);
                }

                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Desculpe, n√£o consegui gerar uma resposta concisa e organizada.";

                aiTextElement.textContent = aiResponseText;
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    aiTextElement.innerHTML = `<strong>Falha na Tarefa:</strong> ${error.message}.`;
                    displayError(`Houve um erro na requisi√ß√£o √† AI. Detalhe: ${error.message}`);
                }
            } finally {
                userImageUrls.forEach(url => URL.revokeObjectURL(url));
                
                abortController = null;
                updateSendButton('send');
                promptInput.disabled = false;
                promptInput.value = '';
                // CRUCIAL: Reseta o input de arquivo para permitir um novo evento 'change'
                imageUpload.value = null; 
                imagePreviewContainer.innerHTML = '';
                selectedFiles = [];
                updateImageCountDisplay(); // Reseta a contagem
            }
        }
        
        function updateSendButton(state) {
            const sendIcon = document.getElementById('send-icon');
            const stopIcon = document.getElementById('stop-icon');
            
            if (state === 'stop') {
                sendButton.classList.add('bg-red-500', 'hover:bg-red-600');
                sendButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                sendIcon.classList.add('hidden');
                stopIcon.classList.remove('hidden');
                sendButton.title = 'Parar Gera√ß√£o';
            } else {
                sendButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                sendButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                sendIcon.classList.remove('hidden');
                stopIcon.classList.add('hidden');
                sendButton.title = 'Enviar Tarefa';
            }
        }
        
        sendButton.addEventListener('click', sendMessage);

        // Inicializa a contagem ao carregar a p√°gina
        updateImageCountDisplay();

    </script>
</body>
</html>
